<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìƒê°ì˜ ë°”ë‹¤ - ì·¨í–¥ ì£¼ì œ ë½‘ê¸°</title>
  <style>
    :root{
      --bg:#f7f8fa; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#2563eb; --primary-hover:#1e40af; --accent:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    h1{margin:0 0 12px; font-size:1.8rem}
    .sub{color:var(--muted); margin-bottom:20px}
    .wrap{max-width:980px; margin:0 auto}
    .toolbar,.footer{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--card); padding:12px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.06);
    }
    select,button{
      padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; color:var(--text); font-size:.95rem;
    }
    button{background:var(--primary); color:#fff; border:none; cursor:pointer}
    button:hover{background:var(--primary-hover)}
    button.ghost{background:#eef2ff; color:#1e3a8a}
    button.gray{background:#e5e7eb; color:#111827}
    button.success{background:var(--accent); color:#fff}
    button.danger{background:var(--danger); color:#fff}
    .grid{display:grid; grid-template-columns:1fr; gap:16px; margin-top:16px}
    @media(min-width:900px){ .grid{grid-template-columns:2fr 1fr} }
    .card{background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .question-box{
      min-height:120px; display:flex; align-items:center; justify-content:center;
      font-size:1.3rem; text-align:center; padding:24px; border:2px dashed #e5e7eb; border-radius:12px; line-height:1.5;
    }
    .meta{display:flex; gap:12px; flex-wrap:wrap; color:var(--muted); margin-top:10px; font-size:.95rem}
    .badge{background:#eef2ff; color:#1e3a8a; padding:4px 8px; border-radius:999px; font-weight:600}
    .count{margin-left:auto}
    .history{max-height:360px; overflow:auto; border-top:1px solid #f3f4f6; margin-top:10px}
    .history-item{display:flex; align-items:start; gap:8px; padding:10px 0; border-bottom:1px dashed #eef2ff}
    .history-item .title{flex:1}
    .list{max-height:460px; overflow:auto}
    .list h4{margin:16px 0 8px; color:#111827}
    .list li{margin:6px 0; color:#374151}
    .timer{display:flex; align-items:center; gap:8px; margin-top:10px}
    .timer .display{
      font-variant-numeric: tabular-nums; font-size:1.6rem; font-weight:800; padding:8px 12px; background:#0ea5e9; color:#fff; border-radius:10px; min-width:120px; text-align:center;
    }
    .status{margin-top:10px; color:var(--muted); min-height:20px}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .25s}
    .toast.show{opacity:1}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ™ï¸ ë‚´ ì·¨í–¥ì„ ì†Œê°œí•©ë‹ˆë‹¤ â€” ì£¼ì œ ë½‘ê¸°</h1>
  <div class="sub">ì¹´í…Œê³ ë¦¬ë§Œ ë˜ëŠ” ë°œí‘œ ê°€ì´ë“œë¥¼ í¬í•¨í•´ ë½‘ê¸° ê°€ëŠ¥. 4ì¸ ì„¸íŠ¸ ë½‘ê¸°ë„ ì§€ì›í•´ìš”.</div>

  <!-- ìƒë‹¨ íˆ´ë°” -->
  <div class="toolbar" role="region" aria-label="controls">
    <div class="row">
      <label for="mode" class="muted">ëª¨ë“œ</label>
      <select id="mode" title="ë½‘ê¸° ëª¨ë“œ">
        <option value="CATEGORY_ONLY">ì¹´í…Œê³ ë¦¬ë§Œ</option>
        <option value="CATEGORY_WITH_PROMPT" selected>ì¹´í…Œê³ ë¦¬ + ë°œí‘œê°€ì´ë“œ</option>
        <option value="PACK4">4ì¸ ì„¸íŠ¸ ë½‘ê¸°</option>
      </select>

      <label for="category" class="muted">ì¹´í…Œê³ ë¦¬</label>
      <select id="category">
        <option value="ALL">ì „ì²´</option>
      </select>

      <div class="row" style="margin-left:8px">
        <input type="checkbox" id="roulette" />
        <label for="roulette">ë£°ë › ì• ë‹ˆë©”ì´ì…˜</label>
      </div>
    </div>

    <button id="btnPick">ğŸ² ë½‘ê¸°</button>
    <button id="btnShowAll" class="ghost">ì „ì²´ ëª©ë¡ í† ê¸€</button>
    <div class="count muted" id="count">0 / 0</div>
  </div>

  <!-- ë³¸ë¬¸ -->
  <div class="grid">
    <section class="card" aria-live="polite">
      <div class="question-box" id="questionBox">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì·¨í–¥ ì£¼ì œë¥¼ ë½‘ì•„ë³´ì„¸ìš”!</div>
      <div class="meta">
        <span class="badge" id="currentCategory">ì¹´í…Œê³ ë¦¬: -</span>
        <span class="badge" id="currentGuide">ë°œí‘œ ê°€ì´ë“œ: -</span>
        <span class="count" id="subcount"></span>
      </div>

      <!-- íƒ€ì´ë¨¸ -->
      <div class="timer">
        <label for="mins" class="muted">íƒ€ì´ë¨¸:</label>
        <select id="mins">
          <option value="10">10ë¶„</option>
          <option value="12">12ë¶„</option>
          <option value="15" selected>15ë¶„</option>
        </select>
        <button id="btnStartTimer" class="success">ì‹œì‘</button>
        <button id="btnPauseTimer" class="ghost">ì¼ì‹œì •ì§€</button>
        <button id="btnResetTimer" class="danger">ë¦¬ì…‹</button>
        <div class="display" id="timerDisplay">00:00</div>
      </div>

      <div class="status" id="status"></div>

      <div class="footer" style="margin-top:12px">
        <button id="btnCopyCurrent" class="ghost">ğŸ“‹ í˜„ì¬ ê²°ê³¼ ë³µì‚¬</button>
        <button id="btnCopyHistory" class="ghost">ğŸ§¾ íˆìŠ¤í† ë¦¬ ë³µì‚¬</button>
        <div style="flex:1"></div>
        <button id="btnResetCat" class="gray">í˜„ì¬ ì¹´í…Œê³ ë¦¬ ì´ˆê¸°í™”</button>
        <button id="btnResetAll" class="danger">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </section>

    <aside class="card">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
        <strong>ğŸ•˜ íˆìŠ¤í† ë¦¬</strong><span class="muted">(ìµœì‹ ìˆœ)</span>
      </div>
      <div class="history" id="history"></div>
    </aside>
  </div>

  <!-- ì „ì²´ ëª©ë¡ -->
  <section class="card" id="allList" style="margin-top:16px; display:none">
    <h3>ğŸ“‹ ëª¨ë“  í•­ëª© (ì¹´í…Œê³ ë¦¬ë³„)</h3>
    <div class="list" id="listContainer"></div>
  </section>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* =========================
   ë°ì´í„° ì •ì˜
========================= */
// ì¹´í…Œê³ ë¦¬ë³„ 'ì·¨í–¥ ì£¼ì œ' í›„ë³´ (ë°œí‘œìëŠ” ì´ ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ 2ë¶„ ì†Œê°œ)
const TOPICS = {
  "ìŒì‹": [
    "ë‚´ ì¸ìƒ ë©”ë‰´ 1ê°€ì§€ + ì¶”ì²œ ì‹ë‹¹",
    "í¸ì˜ì  ì¡°í•©(=ê¿€ì¡°í•©) ë² ìŠ¤íŠ¸",
    "ì§€ì—­ë³„ ìˆ¨ê²¨ì§„ ë§›ì§‘ 1ê³³",
    "ê°€ì„±ë¹„ ë¯¸ì¹œ ì‹ë‹¹ Top1",
    "ìµœì•  ë¼ë©´ ì»¤ìŠ¤í…€ ë ˆì‹œí”¼",
    "ë‹¤ì´ì–´íŠ¸ ë•Œ ë²„í‹°ëŠ” ë©”ë‰´",
    "ë‚´ê°€ ë§Œë“  ì‹œê·¸ë‹ˆì²˜ ë³¶ìŒ/íŒŒìŠ¤íƒ€ ë ˆì‹œí”¼",
    "ë¹„ì˜¤ëŠ” ë‚  ìµœì•  ìŒì‹",
  ],
  "ì¹´í˜/ë””ì €íŠ¸": [
    "ë‚´ ì·¨í–¥ ì¹´í˜ ì¸í…Œë¦¬ì–´/ë¶„ìœ„ê¸°",
    "ì¸ìƒ ë””ì €íŠ¸ Top1 (ì¼€ì´í¬/ë§ˆì¹´ë¡˜/ì¿ í‚¤ ë“±)",
    "ì¹´ê³µí•˜ê¸° ì¢‹ì€ ì¹´í˜ ì¶”ì²œ",
    "ì‹œê·¸ë‹ˆì²˜ ë¼ë–¼/ìŒë£Œ ì¶”ì²œ",
    "í›„íšŒ ì—†ëŠ” ë””ì €íŠ¸ ì¡°í•©",
    "ë‚˜ë§Œ ì•„ëŠ” ë™ë„¤ ì¹´í˜",
    "ì¹´í˜ì—ì„œ ê¼­ ë“£ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸",
  ],
  "ìŒì•…": [
    "ìš”ì¦˜ ë“£ëŠ” ë…¸ë˜ 1ê³¡ + í•œì¤„ ì¶”ì²œ",
    "ë‚˜ë¥¼ ë°”ê¾¼ ì•¨ë²” 1ì¥",
    "ìš´ë™/ì§‘ì¤‘/ì‚°ì±… í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê³µê°œ",
    "ë‚´ ìµœì•  ì•„í‹°ìŠ¤íŠ¸ ì…ë¬¸ ê°€ì´ë“œ",
    "ì½˜ì„œíŠ¸ì—ì„œ ìš¸ì—ˆë˜ ë…¸ë˜",
    "ì•„ì¹¨ì— ë“£ê¸° ì¢‹ì€ ë…¸ë˜",
    "ë°¤ì— ë“£ê¸° ì¢‹ì€ ë…¸ë˜",
  ],
  "ì˜í™”/ë“œë¼ë§ˆ": [
    "ì¸ìƒ ì˜í™” 1í¸ + ì™œ",
    "ìµœê·¼ ëª°ì•„ë³¸ ë“œë¼ë§ˆ ì¶”ì²œ",
    "ì›ƒê³  ì‹¶ì„ ë•Œ ë³´ëŠ” ì‘í’ˆ",
    "ì² í•™ì  ì§ˆë¬¸ ë˜ì§€ëŠ” ì‘í’ˆ ì¶”ì²œ",
    "OSTê°€ ë¯¸ì¹œ ì‘í’ˆ",
    "ë°˜ì „ ìš”ì†Œê°€ ì¢‹ì€ ì‘í’ˆ",
    "íë§ì´ í•„ìš”í•  ë•Œ ë³´ëŠ” ì‘í’ˆ",
  ],
  "ìš´ë™": [
    "ë‚´ ë£¨í‹´ í•µì‹¬ 3ê°œ(ë¶€ìœ„/ë¶„í• /ë¹ˆë„)",
    "ì…ë¬¸ìì—ê²Œ ì¶”ì²œ ìš´ë™ 1ê°€ì§€ + ì´ìœ ",
    "ìš´ë™ ì „/í›„ í•„ìˆ˜ ìŠ¤íŠ¸ë ˆì¹­",
    "PT ì—†ì´ ìì„¸ ì¡ëŠ” íŒ",
    "ìš´ë™í•  ë•Œ ë“£ëŠ” ìŒì•…",
    "ë¶€ìƒ ë°©ì§€ ê¿€íŒ",
    "ì‹ë‹¨ ê´€ë¦¬ í•µì‹¬ 1ê°€ì§€",
  ],
  "ê²Œì„": [
    "ë‚´ ë©”ì¸ ê²Œì„ê³¼ í¬ì§€ì…˜",
    "ì…ë¬¸ì ì¶”ì²œ ê²Œì„ 1ê°œ",
    "ë‚˜ë§Œì˜ ê°ë„/ì„¸íŒ… ê³µê°œ",
    "ì¹œêµ¬ë‘ í•˜ë©´ ê¿€ì¼ íŒŒí‹°ê²Œì„",
    "ì¸ìƒ ìµœê³ ì˜ ìŠ¤í† ë¦¬ ê²Œì„",
    "ì£½ì„ ë•Œê¹Œì§€ ëª» ìŠì„ ëª…ì¥ë©´",
    "íœ´ì‹ìš© ìºì£¼ì–¼ ê²Œì„",
  ],
  "ì•±/íˆ´": [
    "ì¸ìƒ ìƒì‚°ì„± ì•± 1ê°œ",
    "ë©”ëª¨/ìº˜ë¦°ë”/íƒ€ì´ë¨¸ ì¡°í•©",
    "ì‹œê°„ ì¶”ì /ìŠµê´€ ê´€ë¦¬ ë£¨í‹´",
    "ì‚¬ì§„/ì˜ìƒ í¸ì§‘ íˆ´ ì¶”ì²œ",
    "í•™ìƒì—ê²Œ ê¿€ì¸ í• ì¸ê°€/í˜œíƒ",
    "ê°œë°œìë¼ë©´ í•„ìˆ˜ í™•ì¥í”„ë¡œê·¸ë¨",
    "ìš”ì¦˜ ì œì¼ ìì£¼ ì“°ëŠ” ì•±",
  ],
  "ì—¬í–‰": [
    "ë‚´ê°€ ì‚¬ë‘í•œ ë„ì‹œ + ì´ìœ ",
    "ì§§ê²Œ ë– ë‚˜ëŠ” 1ë°•2ì¼ ë£¨íŠ¸",
    "íë§ì´ í•„ìš”í•  ë•Œ ê°€ëŠ” ì¥ì†Œ",
    "ê°€ì„±ë¹„ êµ­ë‚´ ì—¬í–‰ì§€",
    "ë¹„ ì˜¤ëŠ” ë‚  ì¢‹ì€ ì—¬í–‰ì§€/ì½”ìŠ¤",
    "í˜¼ì ê°€ë„ ì¢‹ì€ ì—¬í–‰ì§€",
    "ë§›ìœ¼ë¡œ ê°€ëŠ” ì—¬í–‰(ë¨¹í‚·ë¦¬ìŠ¤íŠ¸)",
  ],
};

// ë°œí‘œ ê°€ì´ë“œ í…œí”Œë¦¿(ì¹´í…Œê³ ë¦¬+ê°€ì´ë“œ ëª¨ë“œì—ì„œ ëœë¤ ì²¨ë¶€)
const PROMPTS = [
  "í˜•ì‹: â€˜ì·¨í–¥ ì´ë¦„ â†’ ì™œ ì¢‹ì€ì§€(2ê°€ì§€) â†’ ì…ë¬¸ì ì¶”ì²œ 1ê°œâ€™",
  "TOP 3 êµ¬ì„±: 3ê°œë§Œ ë½‘ê³  ê° 1ë¬¸ì¥ ì´ìœ ",
  "ìµœì•  vs ì°¨ì„ : ì¥ë‹¨ì  1ê°œì”© ë¹„êµ",
  "ì…ë¬¸ìë¥¼ ìœ„í•œ ì‹œì‘ íŒ 2ê°œ",
  "ë‚˜ë§Œì˜ ê·œì¹™/ë£¨í‹´ 1ê°€ì§€ + ì£¼ì˜í•  ì  1ê°€ì§€",
  "ê°€ê²©/ì ‘ê·¼ì„±/ëŒ€ì²´ì•ˆ ì¤‘ 1ê°œë§Œ ê°•ì¡°í•´ì„œ ì„¤ëª…",
];

// 4ì¸ ì„¸íŠ¸ ë½‘ê¸°ìš©: í•œ ì¡°(4ëª…)ê°€ ê°™ì€ ì¹´í…Œê³ ë¦¬ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ í”„ë¡¬í”„íŠ¸ 4ê°œë¥¼ ë°›ë„ë¡
const PACK_SIZE = 4;

/* =========================
   ìƒíƒœ & ìš”ì†Œ
========================= */
const STORAGE_KEY = "seangbal_tastes_v1";
let used = new Set();        // "ì¹´í…Œê³ ë¦¬|ë¬¸ì¥"
let history = [];            // [{mode, cat, text, guide, ts}]
let current = null;          // {mode, cat, text, guide}
let rouletteOn = false;

const elMode = document.querySelector("#mode");
const elCategory = document.querySelector("#category");
const elQuestion = document.querySelector("#questionBox");
const elCount = document.querySelector("#count");
const elSubCount = document.querySelector("#subcount");
const elCurrentCat = document.querySelector("#currentCategory");
const elCurrentGuide = document.querySelector("#currentGuide");
const elHistory = document.querySelector("#history");
const elAllList = document.querySelector("#allList");
const elListContainer = document.querySelector("#listContainer");
const elStatus = document.querySelector("#status");
const elToast = document.querySelector("#toast");

// ë²„íŠ¼/ì…ë ¥
const btnPick = document.querySelector("#btnPick");
const btnShowAll = document.querySelector("#btnShowAll");
const btnCopyCurrent = document.querySelector("#btnCopyCurrent");
const btnCopyHistory = document.querySelector("#btnCopyHistory");
const btnResetCat = document.querySelector("#btnResetCat");
const btnResetAll = document.querySelector("#btnResetAll");
const cbRoulette = document.querySelector("#roulette");

// íƒ€ì´ë¨¸
const selMins = document.querySelector("#mins");
const btnStartTimer = document.querySelector("#btnStartTimer");
const btnPauseTimer = document.querySelector("#btnPauseTimer");
const btnResetTimer = document.querySelector("#btnResetTimer");
const displayTimer = document.querySelector("#timerDisplay");
let timerId = null, remainSec = 0, paused = false;

/* =========================
   ì´ˆê¸°í™”
========================= */
init();
function init(){
  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  for(const cat of Object.keys(TOPICS)){
    const opt = document.createElement("option");
    opt.value = cat; opt.textContent = cat; elCategory.appendChild(opt);
  }
  // ì €ì¥ ë³µì›
  const saved = loadState();
  if(saved){
    used = new Set(saved.used ?? []);
    history = saved.history ?? [];
  }
  updateCounts();
  renderHistory();
  renderAllList();
  setStatus("ì¤€ë¹„ ì™„ë£Œ. ì·¨í–¥ ì£¼ì œë¥¼ ë½‘ì•„ë³´ì„¸ìš”!");
  selfValidateData();
}

/* =========================
   ìŠ¤í† ë¦¬ì§€
========================= */
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ used:[...used], history }));
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ console.warn("loadState fail:", e); return null; }
}

/* =========================
   ìœ í‹¸
========================= */
function toast(msg){
  elToast.textContent = msg; elToast.classList.add("show");
  setTimeout(()=>elToast.classList.remove("show"), 1400);
}
function setStatus(msg){ elStatus.textContent = msg || ""; }
function nowStr(){ const d=new Date(); const p=n=>String(n).padStart(2,"0"); return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
function keyOf(cat, text){ return `${cat}|${text}`; }
function totalCount(){ return Object.values(TOPICS).reduce((a,arr)=>a+arr.length,0); }
function usedCount(){ return used.size; }
function subCount(cat){
  if(cat==="ALL") return { used: usedCount(), total: totalCount() };
  const total = TOPICS[cat].length;
  const usedInCat = [...used].filter(k=>k.startsWith(cat+"|")).length;
  return { used: usedInCat, total };
}

/* =========================
   ë Œë”ë§
========================= */
function updateCounts(){
  elCount.textContent = `${usedCount()} / ${totalCount()}`;
  const cat = elCategory.value || "ALL";
  const sc = subCount(cat);
  elSubCount.textContent = `ì´ ì¹´í…Œê³ ë¦¬ ì§„í–‰: ${sc.used} / ${sc.total}`;
}
function renderHistory(){
  elHistory.innerHTML = "";
  if(history.length===0){
    const p = document.createElement("p");
    p.className="muted"; p.textContent="ì•„ì§ ë½‘íŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
    elHistory.appendChild(p); return;
  }
  for(const item of [...history].reverse()){
    const row = document.createElement("div"); row.className="history-item";
    const t = document.createElement("div"); t.className="title";
    const guide = item.guide ? `<br><small class="muted">${item.guide}</small>` : "";
    t.innerHTML = `<strong>[${item.modeLabel}] ${item.text}</strong><br><small>${item.cat}</small>${guide}`;
    const time = document.createElement("small"); time.className="muted"; time.textContent = item.ts;
    const btn = document.createElement("button"); btn.className="ghost"; btn.textContent="ë³µì‚¬";
    btn.onclick = ()=>copyText(`[${item.modeLabel}] ${item.text} (${item.cat})${item.guide? " Â· "+item.guide:""}`);
    row.appendChild(t); row.appendChild(time); row.appendChild(btn);
    elHistory.appendChild(row);
  }
}
function renderAllList(){
  elListContainer.innerHTML = "";
  for(const [cat, arr] of Object.entries(TOPICS)){
    const h = document.createElement("h4"); h.textContent = cat;
    const ul = document.createElement("ul");
    for(const text of arr){
      const usedMark = used.has(keyOf(cat,text)) ? " Â· ì‚¬ìš©ë¨" : "";
      const li = document.createElement("li"); li.textContent = `${text}${usedMark}`;
      ul.appendChild(li);
    }
    elListContainer.appendChild(h); elListContainer.appendChild(ul);
  }
}
function updateCurrentUI(item){
  if(!item){
    elQuestion.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ì·¨í–¥ ì£¼ì œë¥¼ ë½‘ì•„ë³´ì„¸ìš”!";
    elCurrentCat.textContent = "ì¹´í…Œê³ ë¦¬: -";
    elCurrentGuide.textContent = "ë°œí‘œ ê°€ì´ë“œ: -";
    return;
  }
  elQuestion.innerHTML = item.mode==="PACK4" ? item.text.replace(/\n/g,"<br>") : item.text;
  elCurrentCat.textContent = `ì¹´í…Œê³ ë¦¬: ${item.cat}`;
  elCurrentGuide.textContent = `ë°œí‘œ ê°€ì´ë“œ: ${item.guide || "-"}`;
}

/* =========================
   ì¶”ì²¨ ë¡œì§
========================= */
function availablePool(cat){
  const pool=[];
  const cats = (cat==="ALL")? Object.keys(TOPICS) : [cat];
  for(const c of cats){
    for(const text of TOPICS[c]){
      if(!used.has(keyOf(c,text))) pool.push({cat:c, text});
    }
  }
  return pool;
}
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

async function pick(){
  const mode = elMode.value;
  const cat = elCategory.value;
  let result;

  if(mode==="PACK4"){
    // 4ì¸ ì„¸íŠ¸: ê°™ì€ ì¹´í…Œê³ ë¦¬ì—ì„œ ì¤‘ë³µ ì—†ëŠ” 4ê°œ (ì†Œì§„ ì‹œ ì „ì²´ í´ë°±)
    let pool = availablePool(cat);
    if(cat!=="ALL" && pool.length<PACK_SIZE){
      const all = availablePool("ALL");
      if(all.length<PACK_SIZE){ toast("ì‚¬ìš© ê°€ëŠ¥í•œ í•­ëª©ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ê°€ í•„ìš”í•´ìš”."); setStatus("ì„¸íŠ¸ ë½‘ê¸° ì‹¤íŒ¨: í•­ëª© ë¶€ì¡±"); return; }
      toast("ì„ íƒ ì¹´í…Œê³ ë¦¬ ë¶€ì¡± â†’ ì „ì²´ì—ì„œ ì„¸íŠ¸ ë½‘ê¸°");
      pool = all;
    }
    // ë£°ë ›
    if(rouletteOn){ await rouletteAnimation(pool.map(p=>p.text)); }
    const chosen = [];
    const poolCopy = [...pool];
    for(let i=0; i<PACK_SIZE && poolCopy.length>0; i++){
      const idx = Math.floor(Math.random()*poolCopy.length);
      chosen.push(poolCopy.splice(idx,1)[0]);
    }
    const lines = chosen.map((c,i)=>`${i+1}. ${c.text}`);
    // ì‚¬ìš© ì²˜ë¦¬
    for(const c of chosen) used.add(keyOf(c.cat, c.text));
    result = {
      mode: "PACK4",
      modeLabel: "4ì¸ì„¸íŠ¸",
      cat: (cat==="ALL")? "í˜¼í•©" : cat,
      text: `ì¡°ë³„ 4ì¸ ì„¸íŠ¸\n${lines.join("\n")}`,
      guide: "ê°ì 2ë¶„ ë°œí‘œ: â€˜ì´ë¦„ â†’ ì™œ ì¢‹ì€ì§€(2ê°€ì§€) â†’ ì…ë¬¸ì ì¶”ì²œ 1ê°œâ€™"
    };
  }else{
    // ë‹¨ì¼ ë½‘ê¸°
    let pool = availablePool(cat);
    if(pool.length===0){
      if(cat!=="ALL"){
        pool = availablePool("ALL");
        if(pool.length===0){ toast("ëª¨ë“  í•­ëª©ì„ ì†Œì§„í–ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ê°€ í•„ìš”í•´ìš”."); setStatus("ëª¨ë“  í•­ëª© ì†Œì§„"); return; }
        toast("ì„ íƒ ì¹´í…Œê³ ë¦¬ ì†Œì§„ â†’ ì „ì²´ì—ì„œ ë½‘ê¸°");
      }else{
        toast("ëª¨ë“  í•­ëª©ì„ ì†Œì§„í–ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ê°€ í•„ìš”í•´ìš”."); setStatus("ëª¨ë“  í•­ëª© ì†Œì§„"); return;
      }
    }
    if(rouletteOn){ await rouletteAnimation(pool.map(p=>p.text)); }
    const pickOne = pickRandom(pool);
    used.add(keyOf(pickOne.cat, pickOne.text));
    const withGuide = (mode==="CATEGORY_WITH_PROMPT");
    result = {
      mode,
      modeLabel: withGuide? "ì¹´í…Œê³ ë¦¬+ê°€ì´ë“œ":"ì¹´í…Œê³ ë¦¬",
      cat: pickOne.cat,
      text: pickOne.text,
      guide: withGuide? pickRandom(PROMPTS): null
    };
  }

  current = result;
  history.push({ ...result, ts: nowStr() }); saveState();
  updateCounts(); renderHistory(); renderAllList(); updateCurrentUI(result);
  setStatus("ì¶”ì²¨ ì™„ë£Œ! ë°œí‘œë¥¼ ì‹œì‘í•˜ì„¸ìš”.");
}

function rouletteAnimation(strings){
  return new Promise(resolve=>{
    const span = 700; const start = performance.now();
    const tick = now=>{
      const t = now - start;
      const idx = Math.floor(Math.random()*strings.length);
      elQuestion.textContent = strings[idx];
      if(t<span) requestAnimationFrame(tick); else resolve();
    };
    requestAnimationFrame(tick);
  });
}

/* =========================
   íƒ€ì´ë¨¸
========================= */
function startTimer(){ const mins=parseInt(selMins.value,10)||10; remainSec=mins*60; paused=false; if(timerId) clearInterval(timerId); timerId=setInterval(tick,1000); renderTimer(); }
function pauseTimer(){ if(!timerId) return; paused=!paused; btnPauseTimer.textContent = paused? "ì¬ê°œ":"ì¼ì‹œì •ì§€"; }
function resetTimer(){ clearInterval(timerId); timerId=null; paused=false; remainSec=0; renderTimer(); }
function tick(){ if(paused) return; remainSec--; if(remainSec<=0){ clearInterval(timerId); timerId=null; remainSec=0; renderTimer(); chime(); toast("â° íƒ€ì„ì—…! ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ìš”."); return; } renderTimer(); }
function renderTimer(){ const m=Math.floor(remainSec/60), s=remainSec%60; displayTimer.textContent=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }
function chime(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type="sine"; o.frequency.setValueAtTime(880, ctx.currentTime); g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.3); o.stop(ctx.currentTime+0.35); }, 300);}catch(e){} }

/* =========================
   ë³µì‚¬ & ì´ˆê¸°í™” & í† ê¸€
========================= */
function copyText(t){ navigator.clipboard.writeText(t).then(()=>toast("ë³µì‚¬ ì™„ë£Œ!")); }
function copyCurrent(){
  if(!current){ toast("í˜„ì¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  const txt = (current.mode==="PACK4")
    ? `${current.text} (${current.cat}) Â· ${current.guide}`
    : `${current.text} (${current.cat})${current.guide? " Â· "+current.guide:""}`;
  copyText(txt);
}
function copyHistory(){
  if(history.length===0){ toast("íˆìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆì–´ìš”."); return; }
  const lines = history.map(h=>`${h.ts} - [${h.modeLabel}] ${h.text} (${h.cat})${h.guide? " Â· "+h.guide:""}`);
  copyText(lines.join("\n"));
}
function resetCategory(){
  const cat = elCategory.value;
  if(cat==="ALL"){ toast("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•œ ë’¤ ì‹¤í–‰í•˜ì„¸ìš”."); return; }
  let cnt=0;
  for(const k of [...used]) if(k.startsWith(cat+"|")){ used.delete(k); cnt++; }
  saveState(); updateCounts(); renderAllList(); toast(`${cat} ì´ˆê¸°í™”: ${cnt}ê°œ í•´ì œ`);
}
function resetAll(){ used=new Set(); history=[]; current=null; saveState(); updateCounts(); renderHistory(); renderAllList(); updateCurrentUI(null); toast("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ"); }
function toggleAllList(){ const show=elAllList.style.display==="none"; elAllList.style.display=show?"block":"none"; btnShowAll.textContent=show?"ì „ì²´ ëª©ë¡ ìˆ¨ê¸°ê¸°":"ì „ì²´ ëª©ë¡ í† ê¸€"; }

/* =========================
   ìê°€ ê²€ì¦
========================= */
function selfValidateData(){
  const seen=new Set(); let dup=[];
  for(const [cat, arr] of Object.entries(TOPICS)){
    for(const text of arr){
      const k=keyOf(cat,text);
      if(seen.has(k)) dup.push(k);
      seen.add(k);
    }
  }
  const invalidUsed=[...used].filter(k=>!seen.has(k));
  if(invalidUsed.length){ for(const k of invalidUsed) used.delete(k); saveState(); }
  console.group("%cë°ì´í„° ê²€ì¦","color:#16a34a;font-weight:700");
  console.log("ì´ í•­ëª© ìˆ˜:", [...seen].length);
  console.log(dup.length? "ì¤‘ë³µ ê°ì§€: "+dup.join(", ") : "ì¤‘ë³µ ì—†ìŒ âœ…");
  console.log(invalidUsed.length? "ì •ì˜ì— ì—†ëŠ” used ì œê±°ë¨: "+invalidUsed.length : "used ì •í•©ì„± OK âœ…");
  console.groupEnd();
}

/* =========================
   ì´ë²¤íŠ¸
========================= */
document.querySelector("#btnPick").addEventListener("click", pick);
document.querySelector("#btnShowAll").addEventListener("click", toggleAllList);
document.querySelector("#btnCopyCurrent").addEventListener("click", copyCurrent);
document.querySelector("#btnCopyHistory").addEventListener("click", copyHistory);
document.querySelector("#btnResetCat").addEventListener("click", resetCategory);
document.querySelector("#btnResetAll").addEventListener("click", resetAll);
document.querySelector("#roulette").addEventListener("change", e=>{ rouletteOn = e.target.checked; });
document.querySelector("#category").addEventListener("change", ()=>{ updateCounts(); setStatus("ì¹´í…Œê³ ë¦¬ ë³€ê²½ë¨."); });

// íƒ€ì´ë¨¸
document.querySelector("#btnStartTimer").addEventListener("click", startTimer);
document.querySelector("#btnPauseTimer").addEventListener("click", pauseTimer);
document.querySelector("#btnResetTimer").addEventListener("click", resetTimer);

// ë‹¨ì¶•í‚¤: Enterë¡œ ë¹ ë¥¸ ë½‘ê¸°
document.addEventListener("keydown", e=>{ if(e.key==="Enter") pick(); });
</script>
</body>
</html>
